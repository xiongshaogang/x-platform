<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xplatform.base.orgnaization.module.mybatis.dao.ModuleMybatisDao">
	<resultMap id="ModuleTreeMap" type="ModuleTreeVo">
		<id column="ID" property="id" />
		<result column="name" property="name" />
		<result column="code" property="code" />
		<result column="iconCls" property="iconCls" />
		<result column="url" property="url" />
		<result column="level" property="level" />
		<result column="isIframe" property="isIframe" />
		<result column="checked" property="checked" />
		<result column="parentId" property="parentId" />
		<result column="isLeaf" property="isLeaf" />
		<result column="subSystem" property="subsystem" />
		<result column="subSystemName" property="subSystemName" />
		<result column="phoneShow" property="phoneShow" />
	</resultMap>
	
	<sql id="moduleTreeColumn">
		m.phoneShow,
		m.subSystem,
		m.subSystemName,
		m.id,
		m.name,
		m.code,
		m.iconCls,
		m.url,
		m.level,
		m.isLeaf,
		m.isIframe,
		m.orderby,
		m.parentId
	</sql>
	
	<select id="queryModuleAuthorityByRole" parameterType="hashmap" resultMap="ModuleTreeMap" resultType="ModuleTreeVo">
		select m.phoneShow, m.subSystem,m.subSystemName,m.id, m.name,m.isLeaf,m.iconCls,m.url,m.parentId,m.code,case when rm.ID is null then '0' else '1' end checked 
		from t_org_module m
		left JOIN t_org_role_module rm on m.ID=rm.moduleId and rm.roleId=#{roleId}
		where m.parentId=#{parentId} 
		order by m.orderby
	</select>
	
	<!-- <select id="queryModuleAuthorityByUser" parameterType="hashmap" resultMap="ModuleTreeMap" resultType="ModuleTreeVo">
		select m.phoneShow,m.subSystem,m.subSystemName,m.id, m.name,m.isLeaf,m.iconCls,m.url,m.parentId,m.code,case when um.ID is null then '0' else '1' end checked 
		from t_org_module m
		left JOIN t_org_user_module um on m.ID=um.module_id and um.user_id=#{userId}
		where m.parent_id=#{parentId}
		order by m.orderby
	</select> -->
	
	<select id="queryModuleAuthority" parameterType="hashmap" resultMap="ModuleTreeMap">
		select 
		<include refid="moduleTreeColumn"/> 
		from t_org_role r,t_org_module m,t_org_role_module rm
		where r.id = rm.roleId and m.id = rm.moduleId 
		<if test="roleIds !=null">
		   and r.id in <foreach separator=","	collection="roleIds" item="item" close=")" open="(">${item}</foreach>
		</if>
		<if test="roleIds ==null">
		  and 1 <![CDATA[<>]]> 1
		</if>
	</select>
	
	<select id="queryAllModuleAuthority" resultMap="ModuleTreeMap">
		SELECT <include refid="moduleTreeColumn"/> FROM t_org_module m
	</select>
</mapper>